# .github/workflows/trim_commit_history.yml
name: Trim to Last 2 Commits on New Push

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch

jobs:
  trim_commits:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch full commit history

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

 - name: Remove older commits and push
  run: |
    # Get the total number of commits
    total_commits=$(git rev-list --count HEAD)
    
    # Check if we have more than 2 commits
    if [ "$total_commits" -gt 2 ]; then
      # Keep only the last 2 commits
      git reset --hard HEAD~$((total_commits - 2))
      git push --force "https://${{ secrets.PAT_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git" main
    else
      echo "Less than 3 commits, no action taken"
    fi
  shell: /usr/bin/bash -e
